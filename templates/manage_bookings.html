{% extends 'base.html' %}

{% block title %}Керування Замовленнями - LuxDrive{% endblock %}

{% block content %}
<section>
    <div class="section-title">
        <h2>Керування Замовленнями</h2>
        <p>Панель для менеджерів</p>
    </div>

    <div style="max-width: 1200px; margin: 0 auto;">

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div
            style="padding: 10px; margin-bottom: 20px; border-radius: 5px; background: {{ '#4CAF50' if category == 'success' else '#f44336' }}; color: white; text-align: center;">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div
            style="background: #1a1a1a; padding: 20px; border-radius: 10px; margin-bottom: 30px; border: 1px solid #D4AF37;">
            <h3 style="color: #D4AF37; margin-bottom: 15px;"><i class="fas fa-car-side"></i> Активні поїздки (зараз в
                дорозі)</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                {% set active_count = namespace(value=0) %}
                {% for booking in bookings %}
                {% if booking.status == 'Confirmed' and booking.start_date <= today and booking.end_date>= today %}
                    {% set active_count.value = active_count.value + 1 %}
                    <div
                        style="background: #222; padding: 15px; border-radius: 8px; border: 1px solid #333; width: 280px;">
                        <div style="font-weight: bold; margin-bottom: 5px; color:white;">{{ booking.car.brand }} {{
                            booking.car.model }}</div>
                        <div style="font-size: 14px; color: #a0a0a0;">
                            <span>Клієнт: {{ booking.customer_name }}</span><br>
                            <span>Тел: {{ booking.customer_phone }}</span>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% if active_count.value == 0 %}
                    <p style="color: #a0a0a0;">Поки ніхто не катається.</p>
                    {% endif %}
            </div>
        </div>

        <div style="margin-bottom: 20px; display: flex; gap: 10px;">
            <a href="{{ url_for('manage_bookings') }}" class="btn-outline"
                style="padding: 5px 15px; font-size: 14px;">Всі замовлення</a>
            <a href="{{ url_for('manage_bookings', status='New') }}" class="btn-outline"
                style="padding: 5px 15px; font-size: 14px;">Тільки нові</a>
        </div>

        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; background: #1a1a1a;">
                <thead>
                    <tr style="background: #222; text-align: left;">
                        <th style="padding: 12px; border: 1px solid #333;">№</th>
                        <th style="padding: 12px; border: 1px solid #333;">Клієнт</th>
                        <th style="padding: 12px; border: 1px solid #333;">Автомобіль</th>
                        <th style="padding: 12px; border: 1px solid #333;">Дати</th>
                        <th style="padding: 12px; border: 1px solid #333;">Сума</th>
                        <th style="padding: 12px; border: 1px solid #333;">Статус</th>
                        <th style="padding: 12px; border: 1px solid #333;">Дії</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in bookings %}
                    <tr style="border-bottom: 1px solid #333;">
                        <td style="padding: 12px;">{{ booking.id }}</td>
                        <td style="padding: 12px;">
                            <b>{{ booking.customer_name }}</b><br>
                            <span style="font-size: 12px; color: #a0a0a0;">{{ booking.customer_phone }}</span>
                        </td>
                        <td style="padding: 12px;">{{ booking.car.brand }} {{ booking.car.model }}</td>
                        <td style="padding: 12px; font-size: 14px;">
                            {{ booking.start_date }} - {{ booking.end_date }}
                        </td>
                        <td style="padding: 12px;">${{ booking.total_price }}</td>
                        <td style="padding: 12px;">
                            <span
                                style="padding: 3px 8px; border-radius: 3px; font-size: 12px; color: white; background: {{ '#FF9800' if booking.status == 'New' else ('#4CAF50' if booking.status == 'Confirmed' else ('#2196F3' if booking.status == 'Completed' else '#f44336')) }};">
                                {{ booking.status }}
                            </span>
                        </td>
                        <td style="padding: 12px;">
                            {% if booking.status == 'New' %}
                            <a href="{{ url_for('update_booking_status', booking_id=booking.id, action='confirm') }}"
                                style="color: #4CAF50;">Підтвердити</a>
                            <a href="{{ url_for('update_booking_status', booking_id=booking.id, action='cancel') }}"
                                style="color: #f44336; margin-left: 10px;">Скасувати</a>
                            {% elif booking.status == 'Confirmed' %}
                            <a href="{{ url_for('update_booking_status', booking_id=booking.id, action='complete') }}"
                                style="color: #2196F3;">Завершити</a>
                            {% else %}
                            <span>---</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>
{% endblock %}